<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/background.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Lounge Access</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 20px;
        }
        .container_bag {
            top: 50%;
            max-width: 400px;
            background: white;
            padding: 20px;
            margin: 120px auto 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: rgba(151, 149, 149, 0.4);
            border-radius: 10px;
        }
        .name{
            position: absolute;
            right: 0%;
        }
        select, input, .calculate-btn, .pay-btn {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .calculate-btn {
            background-color: #007bff;
            color: white;
        }
        .calculate-btn:hover {
            background-color: #0056b3;
        }
        .pay-btn {
            background-color: #28a745;
            color: white;
            display: none;
        }
        .pay-btn:hover {
            background-color: #218838;
        }
        .result {
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #007bff;
            padding: 15px;
            color: white;
        }
        .navbar .logo {
            height: 50px;
        }
        .navbar .nav-links {
            display: flex;
            gap: 15px;
        }
        .nav-links a {
            text-decoration: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
        }
        .nav-links a:hover {
            background-color: #0056b3;
        }
        .dropdown {
            position: absolute;
            left: 20%;
            width: 50px;
            border-radius: 20px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(231, 230, 230, 0.4);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 0; 
            visibility: hidden;
            transform: translateY(-10px);
        }
        .dropdown:hover .dropdown-content {
            display: block;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-content a {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease, padding-left 0.3s ease;
        }
        .dropdown-content a:hover {
            background-color: rgba(143, 143, 143, 0.4);
            color: #000000;
            padding-left: 20px;
        }
        .dropdown > a {
            text-decoration: none;
            color: #000000;
            font-size: 18px;
            padding: 12px;
            font-weight: bold;
            display: inline-block;
            transition: color 0.3s ease;
        }
        .dropdown > a:hover {
            color: #333333;
        }
        .contact_button{
            margin-right: 40px;
            padding-right: 40px;
        }
        .bag_bg {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            background-image: url('your-background-image.jpg');
            background-size: cover; 
            background-position: center;
            z-index: -1;
        }
        .bg_lounge{
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            background-image: url('images/back2.jpeg');
            background-size: cover; 
            background-position: center;
            z-index: -1;
        }
        /* Notification styles */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .animate-bounce {
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">
    <div class="header">
        <img class="logo" src="images/air_logo.png">
        <p class="name">CLOUDTRIP</p>
        <div class="buttons">
            <a href="login_page.html"><button class="login_button">Login</button></a>
            <a href="index.html"><button class="home_button">Home</button></a>
            <a href="about_page.html"><button class="about_button">About</button></a>
            
        </div>
        <div class="dropdown">
            <a href="#">Prime Facilities</a>
            <div class="dropdown-content">
                <a href="lounge.html">VIP Lounge</a>
                <a href="entertainment.html">Entertainment Package</a>
                <a href="baggage.html">Baggage Fee Estimator</a>
                <a href="fare.html">Fare Prediction</a>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center" style="margin-top: 120px;">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Airport Lounge Access</h2>
        <form id="serviceForm">
            <div class="mb-4 text-left">
                <label class="block font-medium text-gray-600" for="passport">Passport Number</label>
                <input type="text" id="passport" name="passport" required placeholder="Enter your passport number" 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4 text-left">
                <label class="block font-medium text-gray-600" for="airline">Select Airline</label>
                <select id="airline" name="airline" required 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="">-- Select Airline --</option>
                    <option value="Air India">Air India</option>
                    <option value="Indigo">Indigo</option>
                    <option value="Qatar Airways">Qatar Airways</option>
                    <option value="Emirates Airways">Emirates Airways</option>
                </select>
            </div>
            <div class="mb-4 text-left">
                <label class="block font-medium text-gray-600" for="lounge">Select Lounge Location:</label>
                <select id="lounge" name="lounge" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="0">-- Select Lounge --</option>
                    <option value="2500">Mumbai Airport Lounge - ₹2500</option>
                    <option value="3000">Delhi Airport Lounge - ₹3000</option>
                    <option value="4000">Dubai Airport Lounge - ₹4000</option>
                    <option value="5000">London Airport Lounge - ₹5000</option>
                </select>
            </div>
            <div class="text-lg font-semibold text-gray-700 mb-4" id="priceText">Price: ₹0</div>
            <button id="confirmBtn" type="submit" disabled 
                class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg mt-4 transition duration-300 hover:bg-blue-700 disabled:bg-gray-400">
                Confirm Purchase
            </button>
        </form>
        <div class="text-sm text-gray-500 mt-4">Need help? Contact our support team.</div>
    </div>

    <div id="notification" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg hidden text-center">
        <p id="notificationText" class="font-bold"></p>
    </div>
    <img class="bg_lounge" src="images/back2.jpeg" alt="">

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
        
        const supabase = createClient(
            "https://psvfacqymwdovnjnhowo.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzdmZhY3F5bXdkb3Zuam5ob3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI3MzI1NDYsImV4cCI6MjA1ODMwODU0Nn0.Q2s9rR30QQUkdZ02YM2HJyGWfB3I9omST4n2gEUqLic"
        );
    
        async function addToExistingFee(loungePrice) {
            try {
                // 1. Find most recent record with current fee value
                const { data: recentBooking } = await supabase
                    .from('bookings')
                    .select('id,fees,created_at')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
    
                const { data: recentSpecial } = await supabase
                    .from('special_pass')
                    .select('id,fees,created_at')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
    
                // 2. Determine which is newest
                let targetTable, targetId, currentFee;
                if (recentBooking && recentSpecial) {
                    if (new Date(recentBooking.created_at) > new Date(recentSpecial.created_at)) {
                        [targetTable, targetId, currentFee] = ['bookings', recentBooking.id, recentBooking.fees];
                    } else {
                        [targetTable, targetId, currentFee] = ['special_pass', recentSpecial.id, recentSpecial.fees];
                    }
                } 
                else if (recentBooking) {
                    [targetTable, targetId, currentFee] = ['bookings', recentBooking.id, recentBooking.fees];
                }
                else if (recentSpecial) {
                    [targetTable, targetId, currentFee] = ['special_pass', recentSpecial.id, recentSpecial.fees];
                }
                else {
                    throw new Error("No records found");
                }
    
                // 3. Calculate new fee (existing + new)
                const newFee = (currentFee || 0) + 
                             (targetTable === 'bookings' 
                              ? parseFloat(loungePrice) 
                              : parseInt(loungePrice));
    
                // 4. Update the record
                const { error } = await supabase
                    .from(targetTable)
                    .update({ fees: newFee })
                    .eq('id', targetId);
    
                if (error) throw error;
    
                alert(`✅ Added ₹${loungePrice} to existing fee. New total: ₹${newFee}`);
    
            } catch (error) {
                alert(`❌ Failed: ${error.message}`);
                console.error("Error details:", {
                    error,
                    recentBooking,
                    recentSpecial,
                    inputPrice: loungePrice
                });
            }
        }
    
        // Initialize form
        document.addEventListener('DOMContentLoaded', () => {
            const loungeSelect = document.getElementById("lounge");
            const confirmBtn = document.getElementById("confirmBtn");
    
            loungeSelect.addEventListener("change", () => {
                confirmBtn.disabled = !loungeSelect.value;
            });
    
            document.getElementById("serviceForm").addEventListener("submit", (e) => {
                e.preventDefault();
                addToExistingFee(loungeSelect.value);
            });
        });
    </script>
</body>
</html>