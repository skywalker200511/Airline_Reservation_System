<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/background.css">
    <link rel="stylesheet" href="flight_details.html">
        <title>Ticket Generation</title>
    </head>
    <style>
body {
    
    background-image: url('images/ticekt_bg.png');
    background-size: cover; /* Ensures the image covers the entire viewport */
    background-position: center; /* Centers the image */
    background-repeat: no-repeat; 
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 20px;
        }
        .container_bag {
            top: 50%;
            max-width: 400px;
            background: white;
            padding: 20px;
            margin: 120px auto 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: rgba(151, 149, 149, 0.4);
            border-radius: 10px;
        }
        .name{
            position: absolute;
            right: 0%;
        }
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: #ffffff;
    padding: 15px;
    color: white;
}
.navbar .logo {
    height: 50px;
}
.navbar .nav-links {
    display: flex;
    gap: 15px;
}
.nav-links a {
    text-decoration: none;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
}
.nav-links a:hover {
    background-color: #0056b3;
}
.dropdown {
    position: absolute;
    left: 20%;
    width: 50px;
    border-radius: 20px;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: rgba(231, 230, 230, 0.4);
    min-width: 160px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    z-index: 1;
    border-radius: 5px;
    overflow: hidden;
    transition: all 0.3s ease;
    opacity: 0; 
    visibility: hidden;
    transform: translateY(-10px);
}
.dropdown:hover .dropdown-content {
    display: block;
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.dropdown-content a {
    display: block;
    padding: 12px 16px;
    color: #333;
    text-decoration: none;
    font-size: 16px;
    font-weight: 500;
    transition: background-color 0.3s ease, padding-left 0.3s ease;
}
.dropdown-content a:hover {
    background-color: rgba(143, 143, 143, 0.4);
    color: #000000;
    padding-left: 20px;
}
.dropdown > a {
    text-decoration: none;
    color: #000000;
    font-size: 18px;
    padding: 12px;
    font-weight: bold;
    display: inline-block;
    transition: color 0.3s ease;
}
.dropdown > a:hover {
    color: #333333;
}
.contact_button{
    margin-right: 40px;
    padding-right: 40px;
}
.bag_bg {
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; 
    background-image: url('your-background-image.jpg');
    background-size: cover; 
    background-position: center;
    z-index: -1;
}
.prime_facilities_button{
    background-color: rgba(143, 143, 143, 0);
}
.facility_button{
    background-color: rgba(143, 143, 143, 0);
}
.bk_btn{
    background-color: #0056b3;
    margin-top: 660px;
    margin-left: 40px;
    z-index: +10;
    padding: 10px;
    width: 150px;
}
.main_con{
    height: 50%;
    width: 50%;
    top: 200px;
}





.data-container {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    max-width: 800px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
  }
  
  .container-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }
  
  .record-card {
    background: #f9f9f9;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 8px;
  }
  
  #refresh-btn {
    background: #f0f0f0;
    border: 1px solid #ddd;
    padding: 4px 8px;
    cursor: pointer;
  }

  /* Center the ticket container horizontally and vertically */
body {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
  background-color: #f5f5f5; /* Optional light background */
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
    </style>


    <body>
       
        <div class="header">
            <div class="header">
                <img class="logo" src="images/air_logo.png">
                <p class="name">CLOUDTRIP</p>
                <div class="buttons">
                    <a href="login_page.html"><button class="login_button">Login</button></a>
                    <a href="index.html"><button class="home_button">Home</button></a>
                    <a href="about_page.html"><button class="about_button">About</button></a>
                    
                </div>
                <div class="dropdown">
                    <a href="#">Prime Facilities</a>
                    <div class="dropdown-content">
                        <a href="lounge.html">VIP Lounge</a>
                        <a href="entertainment.html">Entertainment Package</a>
                        <a href="baggage.html">Baggage Fee Estimator</a>
                        <a href="fare.html">Fare Prediction</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="ticket">
            <div class="ticket-header">
              <h2>CLOUDTRIP</h2>
              <div class="ticket-id">#<span id="booking-id">LOADING...</span></div>
            </div>
          
            <!-- Dynamic Passenger Section -->
  <div class="ticket-section">
    <div class="ticket-row">
      <span class="label">Passenger:</span>
      <span id="passenger-name" class="value">LOADING...</span>
    </div>
    <div class="ticket-row">
      <!-- This label will change automatically -->
      <span id="dob-or-disability-label" class="label">Loading...</span>
      <span id="passenger-details" class="value">LOADING...</span>
    </div>
  </div>
            
          
            <!-- Flight Section (now properly classed) -->
            <div class="ticket-section flight-section">  <!-- Added flight-section class here -->
              <div class="ticket-row">
                <span class="label">Flight Type:</span>
                <span id="flight-type" class="value">LOADING...</span>
              </div>
              <div class="ticket-row">
                <span class="label">Flight ID:</span>
                <span id="flight-id" class="value">LOADING...</span>
              </div>
            </div>
          
            <!-- Payment/Special Needs Section -->
            <div class="ticket-section highlight">
              <div class="ticket-row">
                <span class="label">Fees:</span>
                <span id="booking-fees" class="value">â‚¹0.00</span>
              </div>
              <div class="ticket-row">
                <span class="label">Special Assistance:</span>
                <span id="special-needs" class="value">LOADING...</span>
              </div>
            </div>
          </div>

<style>
  .ticket {
    width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    overflow: hidden;
    font-family: 'Segoe UI', sans-serif;
    margin: 20px auto;
    border: 1px solid #e0e0e0;
  }

  .ticket-header {
    background: #2c3e50;
    color: white;
    padding: 15px;
    text-align: center;
    position: relative;
  }

  .ticket-header h2 {
    margin: 0;
    font-size: 1.4rem;
    letter-spacing: 1px;
  }

  .ticket-id {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: #3498db;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .ticket-section {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
  }

  .ticket-section.highlight {
    background: #f8f9fa;
  }

  .ticket-row {
    display: flex;
    margin-bottom: 10px;
    align-items: center;
  }

  .label {
    font-weight: 600;
    width: 140px;
    color: #7f8c8d;
    font-size: 0.9rem;
  }

  .value {
    flex-grow: 1;
    font-weight: 500;
    color: #2c3e50;
  }

  #special-needs {
    color: #e74c3c;
    font-weight: 600;
  }
</style>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const supabase = createClient(
      'https://psvfacqymwdovnjnhowo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzdmZhY3F5bXdkb3Zuam5ob3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI3MzI1NDYsImV4cCI6MjA1ODMwODU0Nn0.Q2s9rR30QQUkdZ02YM2HJyGWfB3I9omST4n2gEUqLic'
    )
  
    // Get all DOM elements
    const elements = {
      bookingId: document.getElementById('booking-id'),
      passengerName: document.getElementById('passenger-name'),
      passengerDetails: document.getElementById('passenger-details'),
      detailLabel: document.getElementById('dob-or-disability-label'),
      flightType: document.getElementById('flight-type'),
      flightId: document.getElementById('flight-id'),
      bookingFees: document.getElementById('booking-fees'),
      specialNeeds: document.getElementById('special-needs'),
      flightSection: document.querySelector('.flight-section')
    }
  
    async function displayLatestTicket() {
      try {
        // Fetch both ticket types
        const [
          { data: booking }, 
          { data: special }
        ] = await Promise.all([
          supabase.from('bookings')
            .select('id, name, dob, flight_id, fees, created_at')
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle(),
          supabase.from('special_pass')
            .select('id, full_name, fees, disability_type, created_at')
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle()
        ])
  
        // Determine which is newer
        const getTime = (record) => record?.created_at ? new Date(record.created_at).getTime() : 0
        const isBooking = getTime(booking) >= getTime(special)
        const ticket = isBooking ? booking : special
  
        if (!ticket) {
          elements.passengerName.textContent = "No tickets found"
          return
        }
  
        // Update ticket display
        elements.bookingId.textContent = ticket.id?.toString().slice(0, 8) || 'N/A'
        elements.passengerName.textContent = isBooking ? ticket.name : ticket.full_name || 'N/A'
        
        // DYNAMIC FIELD: Show DOB or Disability Type
        if (isBooking) {
          elements.detailLabel.textContent = "Date of Birth:"
          elements.passengerDetails.textContent = ticket.dob 
            ? new Date(ticket.dob).toLocaleDateString() 
            : 'N/A'
        } else {
          elements.detailLabel.textContent = "Disability Type:"
          elements.passengerDetails.textContent = ticket.disability_type || 'Not specified'
        }
  
        // Flight info (only for bookings)
        if (isBooking) {
          elements.flightSection.style.display = 'block'
          if (ticket.flight_id) {
            const { data: flight } = await supabase
              .from('flights')
              .select('flight_plane_type')
              .eq('flight_id', ticket.flight_id)
              .maybeSingle()
            elements.flightType.textContent = flight?.flight_plane_type || 'N/A'
            elements.flightId.textContent = ticket.flight_id.toString()
          }
        } else {
          elements.flightSection.style.display = 'none'
        }
  
        // Fees and special needs
        elements.bookingFees.textContent = `â‚¹${Number(ticket.fees || 0).toFixed(2)}`
        elements.specialNeeds.textContent = isBooking ? 'NO' : 'YES'
  
      } catch (error) {
        console.error("Error loading ticket:", error)
        elements.passengerName.textContent = "Error loading data"
      }
    }
  
    // Initialize
    displayLatestTicket()
  </script>
    </body>

</html>